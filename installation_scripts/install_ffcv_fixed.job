#!/bin/bash
#SBATCH --partition=gpu_a100
#SBATCH --gpus=1
#SBATCH --cpus-per-task=8
#SBATCH --job-name=ffcv_installation_fixed
#SBATCH --output=ffcv_installation_fixed_%A.out
#SBATCH --time=12:00:00
#SBATCH --mem=40G
#SBATCH --hint=nomultithread

echo "âœ… FFCV Installation Job (Fixed) started at: $(date)"

# Clean environment and load modules
module purge
module load 2023
module load eb/4.9.4

# Set EasyBuild architecture flag as recommended by support team
export EASYBUILD_OPTARCH=''

echo "ğŸ” Checking available OpenCV easyconfigs..."
eb --search OpenCV | grep -E "(4\.8\.1|4\.8\.0)" | head -10

echo "ğŸ” Checking available GStreamer easyconfigs..."
eb --search GStreamer | grep -E "(1\.22\.5|1\.22\.)" | head -5

echo "ğŸ”§ Strategy: Install GStreamer dependencies first, then OpenCV..."

# Try to install GStreamer dependencies
echo "Installing GStreamer/1.22.5-GCC-12.3.0..."
eblocalinstall GStreamer-1.22.5-GCC-12.3.0.eb -r

if [ $? -eq 0 ]; then
    echo "âœ… GStreamer installed successfully"
    
    echo "Installing GST-plugins-base/1.22.5-GCC-12.3.0..."
    eblocalinstall GST-plugins-base-1.22.5-GCC-12.3.0.eb -r
    
    if [ $? -eq 0 ]; then
        echo "âœ… GST-plugins-base installed successfully"
    else
        echo "âš ï¸  GST-plugins-base installation failed, but continuing..."
    fi
else
    echo "âš ï¸  GStreamer installation failed, trying alternative approach..."
fi

echo "ğŸ§¹ Cleaning any existing lock files..."
# Remove any existing lock files that might prevent installation
rm -rf ~/.local/easybuild/RHEL8/2023/software/.locks/*OpenCV*.lock
echo "âœ… Lock files cleaned"

echo "ğŸ”§ Installing OpenCV (using available easyconfigs)..."
# Try the available OpenCV easyconfigs
eblocalinstall OpenCV-4.8.1-foss-2023a-CUDA-12.1.1-contrib.eb -r

# If that fails, try the non-CUDA version
if [ $? -ne 0 ]; then
    echo "âš ï¸  CUDA OpenCV failed, trying non-CUDA version..."
    eblocalinstall OpenCV-4.8.1-foss-2023a-contrib.eb -r
fi

# If that also fails, try the older version
if [ $? -ne 0 ]; then
    echo "âš ï¸  Non-CUDA OpenCV failed, trying older version..."
    eblocalinstall OpenCV-4.8.0-foss-2022b-contrib.eb -r
fi

# Check if any OpenCV installation was successful
if [ $? -eq 0 ]; then
    echo "âœ… OpenCV installation completed successfully"
    
    # Try to load the installed OpenCV (we'll need to find the correct name)
    echo "ğŸ” Looking for installed OpenCV modules..."
    module avail OpenCV 2>&1 | grep -E "(OpenCV|opencv)" | head -10
    
    # Try to load OpenCV (adjust the name based on what was actually installed)
    module load OpenCV/4.8.1-foss-2023a-CUDA-12.1.1-contrib 2>/dev/null || \
    module load OpenCV/4.8.1-foss-2023a-contrib 2>/dev/null || \
    module load OpenCV/4.8.0-foss-2022b-contrib 2>/dev/null || \
    echo "âš ï¸  Could not load OpenCV module, but installation succeeded"
    
    # Verify OpenCV installation
    echo "ğŸ” Verifying OpenCV installation..."
    if pkg-config --modversion opencv4 2>/dev/null; then
        echo "âœ… OpenCV pkg-config working"
    elif pkg-config --modversion opencv 2>/dev/null; then
        echo "âœ… OpenCV pkg-config working (legacy)"
    else
        echo "âš ï¸  OpenCV pkg-config failed, but continuing..."
    fi
    
    # Load conda and activate environment
    echo "ğŸ”§ Loading conda environment..."
    module load Anaconda3/2023.07-2
    source activate devinterp_env
    
    echo "ğŸ”§ Installing FFCV..."
    # Install FFCV with verbose output to see any issues
    python -m pip install --user --no-cache-dir --verbose ffcv
    
    if [ $? -eq 0 ]; then
        echo "âœ… FFCV installation completed successfully"
        
        # Test FFCV import
        echo "ğŸ” Testing FFCV import..."
        python -c "import ffcv; print('âœ… FFCV imported successfully')"
        
    else
        echo "âŒ FFCV installation failed"
        exit 1
    fi
    
else
    echo "âŒ All OpenCV installation attempts failed"
    echo "ğŸ” Trying alternative approach: install OpenCV via conda..."
    
    # Load conda and activate environment
    echo "ğŸ”§ Loading conda environment..."
    module load Anaconda3/2023.07-2
    source activate devinterp_env
    
    # Try installing OpenCV via conda instead
    echo "ğŸ”§ Installing OpenCV via conda..."
    conda install -c conda-forge opencv -y
    
    if [ $? -eq 0 ]; then
        echo "âœ… OpenCV installed via conda successfully"
        
        echo "ğŸ”§ Installing FFCV..."
        python -m pip install --user --no-cache-dir --verbose ffcv
        
        if [ $? -eq 0 ]; then
            echo "âœ… FFCV installation completed successfully"
            
            # Test FFCV import
            echo "ğŸ” Testing FFCV import..."
            python -c "import ffcv; print('âœ… FFCV imported successfully')"
            
        else
            echo "âŒ FFCV installation failed"
            exit 1
        fi
    else
        echo "âŒ Conda OpenCV installation also failed"
        echo "ğŸ” Trying pip installation of OpenCV..."
        
        # Try installing OpenCV via pip as last resort
        python -m pip install --user opencv-python
        
        if [ $? -eq 0 ]; then
            echo "âœ… OpenCV installed via pip successfully"
            
            echo "ğŸ”§ Installing FFCV..."
            python -m pip install --user --no-cache-dir --verbose ffcv
            
            if [ $? -eq 0 ]; then
                echo "âœ… FFCV installation completed successfully"
                python -c "import ffcv; print('âœ… FFCV imported successfully')"
            else
                echo "âŒ FFCV installation failed"
                exit 1
            fi
        else
            echo "âŒ All OpenCV installation methods failed"
            exit 1
        fi
    fi
fi

echo "âœ… Installation job completed at: $(date)" 