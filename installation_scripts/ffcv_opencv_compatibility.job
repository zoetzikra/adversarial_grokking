#!/bin/bash
#SBATCH --partition=gpu_a100
#SBATCH --gpus=1
#SBATCH --cpus-per-task=4
#SBATCH --job-name=fix_ffcv_opencv
#SBATCH --output=ffcv_opencv_compatibility_%A.out
#SBATCH --time=1:00:00
#SBATCH --mem=8G

echo "ğŸ”§ Fixing FFCV OpenCV compatibility..."

# Load modules
module purge
module load 2023
module load Anaconda3/2023.07-2

# Activate conda environment
source activate devinterp_env

echo "ğŸ” Current OpenCV version:"
python -c "import cv2; print(f'OpenCV version: {cv2.__version__}')"

echo "ğŸ”§ Uninstalling current OpenCV..."
pip uninstall opencv-python opencv-python-headless -y

echo "ğŸ”§ Installing OpenCV 4.8.x to match FFCV..."
pip install opencv-python==4.8.1.78

echo "ğŸ”§ Reinstalling FFCV with correct OpenCV..."
pip uninstall ffcv -y
pip install ffcv

echo "ğŸ” Testing FFCV import..."
python -c "import ffcv; print('âœ… FFCV imported successfully')"

echo "ğŸ” Testing OpenCV version compatibility..."
python -c "import cv2; print(f'âœ… OpenCV {cv2.__version__} is compatible')"

echo "âœ… FFCV OpenCV compatibility fixed!" 